<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>RideConnect - Frontend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">RideConnect</a>
  </div>
</nav>
<div class="container my-4">
  <div id="alert-placeholder"></div>

  <div class="card mb-3 p-3">
    <h5>Login</h5>
    <div class="row g-2">
      <div class="col-md-4"><input id="email" class="form-control" placeholder="Email"></div>
      <div class="col-md-4"><input id="password" type="password" class="form-control" placeholder="Password"></div>
      <div class="col-md-2"><button id="btnLogin" class="btn btn-primary">Login</button></div>
      <div class="col-md-2"><button id="btnRegister" class="btn btn-secondary">Register</button></div>
    </div>
  </div>

  <div class="card p-3 mb-3">
    <h5>Filter Rides</h5>
    <div class="row g-2">
      <div class="col-md-4"><input id="filterOrigin" class="form-control" placeholder="Origin"></div>
      <div class="col-md-4"><input id="filterDest" class="form-control" placeholder="Destination"></div>
      <div class="col-md-2"><button id="btnFilter" class="btn btn-outline-primary">Search</button></div>
      <div class="col-md-2"><button id="btnRefresh" class="btn btn-outline-secondary">Refresh</button></div>
    </div>
  </div>

  <div class="card p-3 mb-3">
    <h5>Add Ride (Authenticated users)</h5>
    <div class="row g-2">
      <div class="col-md-3"><input id="rideOrigin" class="form-control" placeholder="Origin"></div>
      <div class="col-md-3"><input id="rideDest" class="form-control" placeholder="Destination"></div>
      <div class="col-md-3"><input id="rideDate" type="datetime-local" class="form-control"></div>
      <div class="col-md-1"><input id="rideSeats" type="number" class="form-control" placeholder="Seats" min="1"></div>
      <div class="col-md-2"><button id="btnAddRide" class="btn btn-success">Add Ride</button></div>
    </div>
  </div>

  <div class="card p-3">
    <h5>Rides</h5>
    <ul id="ridesList" class="list-group"></ul>
  </div>
</div>

<script>
const apiBase = 'http://localhost:3000/api';
let token = null;
let currentUser = null;

function showAlert(msg, type='warning') {
  const html = `<div class="alert alert-${type} alert-dismissible" role="alert">
    ${msg}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>`;
  document.getElementById('alert-placeholder').innerHTML = html;
}

async function fetchRides(origin, destination) {
  let url = apiBase + '/rides';
  const params = [];
  if (origin) params.push('origin=' + encodeURIComponent(origin));
  if (destination) params.push('destination=' + encodeURIComponent(destination));
  if (params.length) url += '?' + params.join('&');
  const res = await fetch(url);
  const data = await res.json();
  renderRides(data);
}

function renderRides(rides) {
  const ul = document.getElementById('ridesList');
  ul.innerHTML = '';
  if (!rides.length) {
    ul.innerHTML = '<li class="list-group-item">No rides found</li>';
    return;
  }
  rides.forEach(r => {
    const li = document.createElement('li');
    li.className = 'list-group-item';
    li.innerHTML = `<div class="d-flex justify-content-between">
      <div>
        <strong>${r.origin} → ${r.destination}</strong>
        <div>When: ${new Date(r.date).toLocaleString()}</div>
        <div>Seats: ${r.seats} • Owner: ${r.owner_name || 'N/A'}</div>
      </div>
      <div>`;
    if (currentUser && currentUser.role === 'admin') {
      li.innerHTML += `<button class="btn btn-sm btn-danger me-1" onclick="deleteRide(${r.id})">Delete</button>
                       <button class="btn btn-sm btn-secondary" onclick="prefillEdit(${r.id})">Edit</button>`;
    }
    li.innerHTML += `</div></div>`;
    ul.appendChild(li);
  });
}

async function login(email, password) {
  try {
    const res = await fetch(apiBase + '/auth/login', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if (res.ok) {
      token = data.token;
      currentUser = data.user;
      showAlert('Logged in as ' + currentUser.email, 'success');
    } else {
      showAlert(data.message || 'Login failed', 'danger');
    }
  } catch (err) {
    showAlert('Network error', 'danger');
  }
}

async function register(email, password) {
  const name = email.split('@')[0];
  try {
    const res = await fetch(apiBase + '/auth/register', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ name, email, password, role: 'user' })
    });
    const data = await res.json();
    if (res.ok) {
      showAlert('Registered. Now login.', 'success');
    } else {
      showAlert(data.message || 'Register failed', 'danger');
    }
  } catch (err) {
    showAlert('Network error', 'danger');
  }
}

async function addRide() {
  if (!token) { showAlert('Login required', 'warning'); return; }
  const origin = document.getElementById('rideOrigin').value;
  const destination = document.getElementById('rideDest').value;
  const date = document.getElementById('rideDate').value;
  const seats = parseInt(document.getElementById('rideSeats').value || '1', 10);
  const res = await fetch(apiBase + '/rides', {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
    body: JSON.stringify({ origin, destination, date, seats })
  });
  const data = await res.json();
  if (res.ok) {
    showAlert('Ride added', 'success');
    fetchRides();
  } else {
    showAlert(data.message || 'Failed to add', 'danger');
  }
}

async function deleteRide(id) {
  if (!token) { showAlert('Login required', 'warning'); return; }
  const res = await fetch(apiBase + '/rides/' + id, {
    method: 'DELETE', headers: { 'Authorization':'Bearer '+token }
  });
  const data = await res.json();
  if (res.ok) {
    showAlert('Ride deleted', 'success');
    fetchRides();
  } else {
    showAlert(data.message || 'Delete failed', 'danger');
  }
}

document.getElementById('btnLogin').addEventListener('click', () => {
  login(document.getElementById('email').value, document.getElementById('password').value);
});
document.getElementById('btnRegister').addEventListener('click', () => {
  register(document.getElementById('email').value, document.getElementById('password').value);
});
document.getElementById('btnFilter').addEventListener('click', () => {
  fetchRides(document.getElementById('filterOrigin').value, document.getElementById('filterDest').value);
});
document.getElementById('btnRefresh').addEventListener('click', () => fetchRides());
document.getElementById('btnAddRide').addEventListener('click', () => addRide());

// initial load
fetchRides();
</script>
</body>
</html>
